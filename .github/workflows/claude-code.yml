---
# GWA Claude Code - Thin Caller Workflow with Project Triggers
name: GWA Claude Code

"on":
  pull_request:
    types: [opened, reopened, synchronize]
  issue_comment:
    types: [created, edited]
  projects_v2_item:
    types: [created, edited, deleted, archived, restored, reordered]
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to work on
        required: true

env:
  GWA_POD: gwa-runner-0
  GWA_NAMESPACE: default

jobs:
  # Handle project column changes
  project-change:
    if: github.event_name == 'projects_v2_item'
    runs-on: ubuntu-latest
    steps:
      - name: Log project event
        run: |
          echo "ðŸŽ¯ Project event detected!"
          echo "Action: ${{ github.event.action }}"
          echo "Project: ${{ github.event.projects_v2_item.project_node_id }}"
          echo "Item: ${{ github.event.projects_v2_item.node_id }}"
          
      - name: Notify workflow triggered
        run: |
          echo "âœ… projects_v2_item webhook is working for org projects!"

  # Determine context and call orchestrator for PR events and @claude comments
  orchestrate:
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Setup kubeconfig
        env:
          KUBECONFIG_DATA: ${{ secrets.GWA_KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
      - name: Run GWA orchestrator
        env:
          POD: ${{ vars.GWA_POD || 'gwa-runner-0' }}
          NAMESPACE: ${{ vars.GWA_NAMESPACE || 'default' }}
          PR: ${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
          TRIGGER: ${{ github.event_name }}
          BRANCH: ${{ github.head_ref || '' }}
          REPO: ${{ github.repository }}
        run: |
          echo "Would run: kubectl exec -n $NAMESPACE $POD -- gwa-orchestrate --pr $PR --repo $REPO"

  # Handle @claude-answer: responses
  respond:
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude-answer:')
    runs-on: ubuntu-latest
    steps:
      - name: Log response
        run: echo "Would handle @claude-answer response"
